# Dujiaoka 支付系统使用说明

## 📋 概述

Dujiaoka支付系统是基于V2Board支付模块移植而来，采用模块化设计，支持多种支付方式，包括支付宝、微信支付、Stripe、EPay等。

## 🏗️ 系统架构

### 核心组件

1. **BasePayment** - 支付基类，提供统一的接口和通用方法
2. **PaymentFactory** - 支付工厂，负责创建和管理支付实例
3. **PaymentException** - 支付异常类，处理支付相关异常
4. **PaymentService** - 支付服务类，提供统一的支付接口

### 支持的支付方式

- `alipay_f2f` - 支付宝当面付
- `epay` - EPay支付
- `stripe_alipay` - Stripe支付宝
- `stripe_checkout` - Stripe结账
- `stripe_credit` - Stripe信用卡
- `stripe_wepay` - Stripe微信支付
- `wechat_pay_native` - 微信支付原生

## 🔧 使用方法

### 1. 基本使用

```php
use App\Service\PaymentService;

// 创建支付订单
$order = [
    'trade_no' => 'ORDER_' . time(),
    'total_amount' => 10000, // 金额（分）
    'user_id' => 1,
    'notify_url' => 'https://your-domain.com/payment/notify',
    'return_url' => 'https://your-domain.com/payment/return'
];

$config = [
    'app_id' => 'your_alipay_app_id',
    'private_key' => 'your_private_key',
    'public_key' => 'your_public_key'
];

try {
    $result = PaymentService::createPayment('alipay_f2f', $config, $order);
    
    if ($result['type'] == 0) {
        // 二维码支付
        $qrCode = $result['data'];
    } elseif ($result['type'] == 1) {
        // 跳转支付
        $payUrl = $result['data'];
    } elseif ($result['type'] == 2) {
        // 直接支付
        $paid = $result['data'];
    }
} catch (PaymentException $e) {
    // 处理支付异常
    echo $e->getMessage();
}
```

### 2. 处理支付回调

```php
// 在支付回调控制器中
public function notify(Request $request)
{
    $paymentType = $request->input('payment_type');
    $config = $this->getPaymentConfig($paymentType);
    $params = $request->all();

    try {
        $result = PaymentService::handleNotify($paymentType, $config, $params);
        
        if ($result) {
            // 支付成功，处理订单
            $tradeNo = $result['trade_no'];
            $callbackNo = $result['callback_no'];
            
            // 更新订单状态
            $this->updateOrderStatus($tradeNo, 'paid');
            
            return response('success');
        } else {
            return response('fail');
        }
    } catch (PaymentException $e) {
        Log::error('Payment notify error: ' . $e->getMessage());
        return response('fail');
    }
}
```

### 3. 获取支付配置表单

```php
// 获取支付方式的配置表单
$form = PaymentService::getPaymentForm('alipay_f2f');

// 表单结构示例
[
    'app_id' => [
        'label' => '支付宝APPID',
        'description' => '支付宝应用的APPID',
        'type' => 'input',
        'required' => true,
    ],
    'private_key' => [
        'label' => '支付宝私钥',
        'description' => '支付宝应用的私钥',
        'type' => 'textarea',
        'required' => true,
    ]
]
```

### 4. 检查支付方式支持

```php
// 检查支付方式是否支持
if (PaymentService::isSupported('alipay_f2f')) {
    echo '支付宝当面付支持';
}

// 获取支持的支付方式列表
$supportedPayments = PaymentService::getSupportedPayments();
```

### 5. 获取支付方式信息

```php
$info = PaymentService::getPaymentInfo('alipay_f2f');

// 返回信息示例
[
    'name' => '支付宝当面付',
    'description' => '支付宝扫码支付',
    'type' => 'qrcode',
    'supported_currencies' => ['CNY']
]
```

## 📝 支付配置

### 支付宝当面付 (alipay_f2f)

```php
$config = [
    'app_id' => '2021000000000000',
    'private_key' => '-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----',
    'public_key' => '-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----',
    'product_name' => '商品名称'
];
```

### EPay支付 (epay)

```php
$config = [
    'url' => 'https://epay.example.com',
    'pid' => '1000',
    'key' => 'your_secret_key'
];
```

### Stripe支付宝 (stripe_alipay)

```php
$config = [
    'currency' => 'USD',
    'stripe_sk_live' => 'sk_live_...',
    'stripe_webhook_key' => 'whsec_...'
];
```

### Stripe结账 (stripe_checkout)

```php
$config = [
    'currency' => 'USD',
    'stripe_sk_live' => 'sk_live_...',
    'stripe_pk_live' => 'pk_live_...',
    'stripe_webhook_key' => 'whsec_...',
    'stripe_custom_field_name' => '联系方式'
];
```

### 微信支付原生 (wechat_pay_native)

```php
$config = [
    'app_id' => 'wx1234567890abcdef',
    'mch_id' => '1234567890',
    'api_key' => 'your_api_key'
];
```

## 🔄 支付流程

### 1. 创建支付订单

```php
// 1. 准备订单数据
$order = [
    'trade_no' => 'ORDER_' . time(),
    'total_amount' => 10000, // 金额（分）
    'user_id' => 1,
    'notify_url' => 'https://your-domain.com/payment/notify',
    'return_url' => 'https://your-domain.com/payment/return'
];

// 2. 选择支付方式并获取配置
$paymentType = 'alipay_f2f';
$config = $this->getPaymentConfig($paymentType);

// 3. 创建支付
$result = PaymentService::createPayment($paymentType, $config, $order);

// 4. 根据返回类型处理
switch ($result['type']) {
    case 0: // 二维码
        return view('payment.qrcode', ['qr_code' => $result['data']]);
    case 1: // 跳转
        return redirect($result['data']);
    case 2: // 直接支付
        return view('payment.success', ['paid' => $result['data']]);
}
```

### 2. 处理支付回调

```php
// 1. 接收回调数据
$params = $request->all();

// 2. 验证并处理
$result = PaymentService::handleNotify($paymentType, $config, $params);

// 3. 更新订单状态
if ($result) {
    $this->processPaymentSuccess($result['trade_no'], $result['callback_no']);
    return response('success');
} else {
    return response('fail');
}
```

## 🛠️ 扩展开发

### 1. 添加新的支付方式

```php
// 1. 创建支付类
class NewPayment extends BasePayment
{
    protected function getRequiredConfig()
    {
        return ['api_key', 'merchant_id'];
    }

    public function form()
    {
        return [
            'api_key' => [
                'label' => 'API密钥',
                'type' => 'input',
                'required' => true,
            ],
            'merchant_id' => [
                'label' => '商户ID',
                'type' => 'input',
                'required' => true,
            ]
        ];
    }

    public function pay($order)
    {
        // 实现支付逻辑
        return [
            'type' => 1,
            'data' => 'https://payment-url.com'
        ];
    }

    public function notify($params)
    {
        // 实现回调验证逻辑
        return [
            'trade_no' => $params['order_id'],
            'callback_no' => $params['transaction_id']
        ];
    }
}

// 2. 注册支付方式
PaymentService::registerPayment('new_payment', NewPayment::class);
```

### 2. 自定义异常处理

```php
try {
    $result = PaymentService::createPayment($paymentType, $config, $order);
} catch (PaymentException $e) {
    switch ($e->getCode()) {
        case PaymentException::CONFIG_ERROR:
            // 处理配置错误
            break;
        case PaymentException::REQUEST_ERROR:
            // 处理请求错误
            break;
        case PaymentException::SIGN_ERROR:
            // 处理签名错误
            break;
        default:
            // 处理其他错误
            break;
    }
}
```

## 📊 日志记录

系统会自动记录支付相关的日志，包括：

- 支付请求日志
- 支付成功日志
- 支付错误日志
- 回调接收日志
- 回调验证日志

日志位置：`storage/logs/laravel.log`

## 🔒 安全注意事项

1. **配置安全**
   - 支付密钥等敏感信息应存储在环境变量中
   - 生产环境不要将密钥硬编码在代码中

2. **回调验证**
   - 所有支付回调都必须验证签名
   - 验证订单金额和状态

3. **异常处理**
   - 完善的异常处理机制
   - 记录详细的错误日志

4. **数据验证**
   - 验证订单数据的完整性
   - 防止重复支付

## 🚀 部署要求

### 依赖包

```bash
# Stripe支付需要安装Stripe SDK
composer require stripe/stripe-php

# 微信支付需要安装Omnipay（可选）
composer require omnipay/omnipay
composer require omnipay/wechatpay
```

### 环境配置

```env
# 支付宝配置
ALIPAY_APP_ID=your_app_id
ALIPAY_PRIVATE_KEY=your_private_key
ALIPAY_PUBLIC_KEY=your_public_key

# Stripe配置
STRIPE_SK_LIVE=your_stripe_secret_key
STRIPE_PK_LIVE=your_stripe_publishable_key
STRIPE_WEBHOOK_KEY=your_webhook_key

# 微信支付配置
WECHAT_APP_ID=your_wechat_app_id
WECHAT_MCH_ID=your_merchant_id
WECHAT_API_KEY=your_api_key
```

## 📞 技术支持

如果在使用过程中遇到问题，请：

1. 查看日志文件获取详细错误信息
2. 检查支付配置是否正确
3. 确认网络连接和防火墙设置
4. 联系技术支持团队

---

**注意**: 本支付系统基于V2Board支付模块移植，部分SDK集成需要根据实际情况进行调整。
